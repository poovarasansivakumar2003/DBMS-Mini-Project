<%- include('includes/header') %>

<div class="bg-gradient-to-br from-blue-50 to-white min-h-screen py-8 px-4">
  <div class="max-w-6xl mx-auto">
    <!-- Page Header -->
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-blue-800"><%= customer.customer_name %>'s Dashboard</h1>
      <p class="text-slate-600 mt-2">Manage your profile, addresses, view your purchase history and purchase</p>
    </div>

    <!-- Main Content Area -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left Column - Profile Card -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
          <!-- Profile Header -->
          <div class="bg-blue-600 p-6 text-white">
            <div class="flex justify-center mb-4">
              <img src="<%= customer.customer_photo %>" alt="Profile Photo" class="w-28 h-28 rounded-full border-4 border-white shadow-lg object-cover">
            </div>
            <h2 class="text-2xl font-semibold text-center"><%= customer.customer_name %></h2>
            <p class="text-blue-100 text-center">Member since <%= new Date(customer.customer_created_at).toLocaleDateString() %></p>
          </div>

          <!-- Customer Details -->
          <div class="p-6">
            <div class="space-y-4">
              <div class="flex items-center">
                <i class="fa-solid fa-id-card text-blue-600 w-8"></i>
                <span class="text-gray-700"><%= customer.customer_id %></span>
              </div>
              <div class="flex items-center">
                <i class="fa-solid fa-envelope text-blue-600 w-8"></i>
                <span class="text-gray-700"><%= customer.customer_email %></span>
              </div>
              <div class="flex items-center">
                <i class="fa-solid fa-phone text-blue-600 w-8"></i>
                <span class="text-gray-700"><%= customer.customer_ph_no %></span>
              </div>
              <div class="flex items-center">
                <i class="fa-solid fa-wallet text-blue-600 w-8"></i>
                <span class="text-gray-700 font-semibold">Balance: $<%= customer.customer_balance_amt %></span>
              </div>
            </div>

            <div class="mt-6 pt-6 border-t border-gray-200">
              <h3 class="text-lg font-semibold text-blue-800 mb-4">Update Profile</h3>
              <form action="/customer/update/customerDashboard" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="customer_id" value="<%= customer.customer_id %>">

                <div class="space-y-4">
                  <div>
                    <label for="customer_name" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <div class="relative">
                      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fa-solid fa-user text-gray-400"></i>
                      </div>
                      <input type="text" id="customer_name" name="customer_name" value="<%= customer.customer_name %>" required class="block w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                  </div>

                  <div>
                    <label for="customer_email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                    <div class="relative">
                      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fa-solid fa-envelope text-gray-400"></i>
                      </div>
                      <input type="email" id="customer_email" name="customer_email" value="<%= customer.customer_email %>" required class="block w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                  </div>

                  <div>
                    <label for="customer_ph_no" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                    <div class="relative">
                      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fa-solid fa-phone text-gray-400"></i>
                      </div>
                      <input type="tel" id="customer_ph_no" name="customer_ph_no" value="<%= customer.customer_ph_no %>" required class="block w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                  </div>

                  <div>
                    <label for="customer_photo" class="block text-sm font-medium text-gray-700 mb-1">Profile Photo</label>
                    <input type="file" id="customer_photo" name="customer_photo" accept="image/*" class="block w-full py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="previewImage(event)">

                    <div class="mt-3 flex items-center gap-4">
                      <img id="image-preview" class="w-16 h-16 rounded-full border border-gray-300 object-cover hidden" alt="Profile Preview">
                      <button type="button" id="remove-image" class="hidden text-sm text-red-500 hover:text-red-700 font-medium" onclick="removeImage()">Remove</button>
                    </div>
                  </div>

                  <div>
                    <label for="customer_password" class="block text-sm font-medium text-gray-700 mb-1">Password <span class="text-red-500">*</span></label>
                    <div class="relative">
                      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-lock text-gray-400"></i>
                      </div>
                      <input type="password" id="customer_password" name="customer_password" required class="block w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                      <button type="button" onclick="togglePassword()" class="absolute inset-y-0 right-0 pr-3 flex items-center">
                        <i id="password-toggle" class="fas fa-eye text-gray-400 hover:text-gray-600 cursor-pointer"></i>
                      </button>
                    </div>
                  </div>

                  <button type="submit" id="submitBtn" class="w-full flex justify-center py-2 px-4 rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all">
                    <div class="flex items-center">
                      <span id="submitText"><i class="fas fa-save mr-2"></i>Save Changes</span>
                    </div>
                    <span id="loadingSpinner" class="hidden ml-2">
                      <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                    </span>
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column - Tabbed Content -->
      <div class="lg:col-span-2">
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
          <!-- Tab Navigation -->
          <div class="flex border-b">
            <button onclick="openTab('addresses')" id="addresses-tab" class="tab-btn flex-1 py-4 font-medium text-center text-blue-800 bg-blue-50 border-b-2 border-blue-600">
              <i class="fa-solid fa-map-marker-alt mr-2"></i>Addresses
            </button>
            <button onclick="openTab('feedback')" id="feedback-tab" class="tab-btn flex-1 py-4 font-medium text-center text-gray-600">
              <i class="fa-solid fa-comment-dots mr-2"></i>Feedback
            </button>
            <button onclick="openTab('purchase')" id="purchase-tab" class="tab-btn flex-1 py-4 font-medium text-center text-gray-600">
              <i class="fa-solid fa-shopping-cart mr-2"></i>Purchase
            </button>
            <button onclick="openTab('invoices')" id="invoices-tab" class="tab-btn flex-1 py-4 font-medium text-center text-gray-600">
              <i class="fa-solid fa-file-invoice-dollar mr-2"></i>Purchase History
            </button>
          </div>

          <!-- Tab Content -->
          <div class="p-6">
            <!-- Addresses Tab -->
            <div id="addresses-content" class="tab-content">
              <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-blue-800">Your Saved Addresses</h3>
                <button onclick="toggleAddAddressForm()" class="flex items-center bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                  <i class="fa-solid fa-plus mr-2"></i> Add New
                </button>
              </div>

              <!-- Add Address Form (Hidden by default) -->
              <div id="add-address-form" class="hidden mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <h4 class="text-lg font-medium text-blue-800 mb-4">Add New Address</h4>
                <form action="/customer/customerDashboard/address/add" method="POST" class="space-y-4">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Street:</label>
                      <input type="text" name="street" required class="w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">City:</label>
                      <input type="text" name="city" required class="w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">State:</label>
                      <input type="text" name="state" required class="w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">ZIP Code:</label>
                      <input type="text" name="zip_code" required class="w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                  </div>

                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Address Type:</label>
                    <select name="address_type" class="w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                      <option value="Home">Home</option>
                      <option value="Work">Work</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>

                  <div class="flex justify-end gap-2">
                    <button type="button" onclick="toggleAddAddressForm()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg">Cancel</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Save Address</button>
                  </div>
                </form>
              </div>

              <!-- Address Cards -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <% if (addresses.length > 0) { %>
                <% addresses.forEach(address => { %>
                <div class="border rounded-lg shadow-sm hover:shadow-md transition p-4 bg-white">
                  <div class="flex justify-between items-start mb-2">
                    <div>
                      <span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded-full"><%= address.address_type %></span>
                      <h4 class="text-sm text-gray-500 mt-1 hidden">ID: <%= address.address_id %></h4>
                    </div>
                    <div class="flex gap-2">
                      <button onclick="toggleEditForm('address-<%= address.address_id %>')" class="text-blue-600 hover:text-blue-800">
                        <i class="fa-solid fa-edit"></i>
                      </button>
                      <form action="/customer/customerDashboard/address/deleteOrEdit" method="POST" class="inline">
                        <input type="hidden" name="address_id" value="<%= address.address_id %>">
                        <button type="submit" name="action" value="delete" class="text-red-600 hover:text-red-800" onclick="return confirm('Are you sure you want to delete this address?')">
                          <i class="fa-solid fa-trash-alt"></i>
                        </button>
                      </form>
                    </div>
                  </div>

                  <div class="mt-3 text-gray-700">
                    <p><%= address.street %></p>
                    <p><%= address.city %>, <%= address.state %> <%= address.zip_code %></p>
                  </div>

                  <!-- Edit Address Form (Hidden) -->
                  <form id="address-<%= address.address_id %>" action="/customer/customerDashboard/address/deleteOrEdit" method="POST" class="mt-4 space-y-3 hidden">
                    <input type="hidden" name="address_id" value="<%= address.address_id %>">

                    <div>
                      <label for="address_type_<%= address.address_id %>" class="block text-xs font-medium text-gray-700">Address Type</label>
                      <select id="address_type_<%= address.address_id %>" name="address_type" required class="w-full border p-2 rounded mt-1">
                        <option value="Home" <%= address.address_type === 'Home' ? 'selected' : '' %>>Home</option>
                        <option value="Work" <%= address.address_type === 'Work' ? 'selected' : '' %>>Work</option>
                        <option value="Other" <%= address.address_type === 'Other' ? 'selected' : '' %>>Other</option>
                      </select>
                    </div>

                    <div>
                      <label for="street_<%= address.address_id %>" class="block text-xs font-medium text-gray-700">Street</label>
                      <input type="text" id="street_<%= address.address_id %>" name="street" value="<%= address.street %>" required class="w-full border p-2 rounded mt-1">
                    </div>

                    <div>
                      <label for="city_<%= address.address_id %>" class="block text-xs font-medium text-gray-700">City</label>
                      <input type="text" id="city_<%= address.address_id %>" name="city" value="<%= address.city %>" required class="w-full border p-2 rounded mt-1">
                    </div>

                    <div>
                      <label for="state_<%= address.address_id %>" class="block text-xs font-medium text-gray-700">State</label>
                      <input type="text" id="state_<%= address.address_id %>" name="state" value="<%= address.state %>" required class="w-full border p-2 rounded mt-1">
                    </div>

                    <div>
                      <label for="zip_code_<%= address.address_id %>" class="block text-xs font-medium text-gray-700">ZIP Code</label>
                      <input type="text" id="zip_code_<%= address.address_id %>" name="zip_code" value="<%= address.zip_code %>" required class="w-full border p-2 rounded mt-1">
                    </div>

                    <button type="submit" name="action" value="edit" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Save Changes</button>
                  </form>
                </div>
                <% }) %>
                <% } else { %>
                <div class="col-span-2 py-8 text-center">
                  <div class="text-gray-400 mb-2"><i class="fa-solid fa-map-marker-alt text-3xl"></i></div>
                  <p class="text-gray-500">You haven't saved any addresses yet.</p>
                  <button onclick="toggleAddAddressForm()" class="mt-3 text-blue-600 hover:text-blue-800 font-medium">+ Add your first address</button>
                </div>
                <% } %>
              </div>
            </div>

            <!-- Feedback Tab -->
            <div id="feedback-content" class="tab-content hidden">
              <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-blue-800">Your Feedback</h3>
                <button onclick="toggleAddFeedbackForm()" class="flex items-center bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                  <i class="fa-solid fa-plus mr-2"></i> Add Feedback
                </button>
              </div>

              <!-- Add Feedback Form (Hidden by default) -->
              <div id="add-feedback-form" class="hidden mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <h4 class="text-lg font-medium text-blue-800 mb-4">Share Your Experience</h4>
                <form action="/customer/customerDashboard/feedback/add" method="POST" class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Rating:</label>
                    <div class="flex items-center">
                      <div class="rating flex gap-1 flex-row-reverse">
                        <% for(let i = 5; i >= 1; i--) { %>
                        <input type="radio" id="star<%= i %>" name="rating" value="<%= i %>" class="hidden">
                        <label for="star<%= i %>" class="text-2xl cursor-pointer text-gray-300 hover:text-yellow-400">★</label>
                        <% } %>
                      </div>
                      <span class="ml-2 text-sm text-gray-500">(1-5 stars)</span>
                    </div>
                  </div>

                  <style>
                    .rating input[type="radio"]:checked~label {
                      color: #facc15;
                      /* Yellow */
                    }
                  </style>

                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Your Comments:</label>
                    <textarea name="feedback_text" required class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent min-h-32" placeholder="Tell us about your experience..."></textarea>
                  </div>

                  <div class="flex justify-end gap-2">
                    <button type="button" onclick="toggleAddFeedbackForm()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg">Cancel</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Submit Feedback</button>
                  </div>
                </form>
              </div>

              <!-- Feedback Cards -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <% if (feedbacks.length > 0) { %>
                <% feedbacks.forEach(feedback => { %>
                <div class="border rounded-lg shadow-sm hover:shadow-md transition p-4 bg-white">
                  <div class="flex justify-between items-start mb-2">
                    <div>
                      <div class="flex">
                        <% for(let i = 1; i <= 5; i++) { %>
                        <span class="text-lg <%= i <= feedback.rating ? 'text-yellow-400' : 'text-gray-300' %>">★</span>
                        <% } %>
                      </div>
                      <p class="text-xs text-gray-500 mt-1">
                        <i class="fa-regular fa-calendar-alt mr-1"></i>
                        <%= new Date(feedback.feedback_date).toLocaleDateString() %>
                      </p>
                    </div>
                    <div class="flex gap-2">
                      <button onclick="toggleEditForm('feedback-<%= feedback.feedback_id %>')" class="text-blue-600 hover:text-blue-800">
                        <i class="fa-solid fa-edit"></i>
                      </button>
                      <form action="/customer/customerDashboard/feedback/deleteOrEdit" method="POST" class="inline">
                        <input type="hidden" name="feedback_id" value="<%= feedback.feedback_id %>">
                        <button type="submit" name="action" value="delete" class="text-red-600 hover:text-red-800" onclick="return confirm('Are you sure you want to delete this feedback?')">
                          <i class="fa-solid fa-trash-alt"></i>
                        </button>
                      </form>
                    </div>
                  </div>

                  <div class="mt-3">
                    <p class="text-gray-700"><%= feedback.feedback_text %></p>
                  </div>

                  <!-- Edit Feedback Form (Hidden) -->
                  <form id="feedback-<%= feedback.feedback_id %>" action="/customer/customerDashboard/feedback/deleteOrEdit" method="POST" class="mt-4 space-y-3 hidden">
                    <input type="hidden" name="feedback_id" value="<%= feedback.feedback_id %>">
                    <div>
                      <label class="block text-xs font-medium text-gray-700 mb-1">Rating (1-5):</label>
                      <div class="flex items-center">
                        <div class="rating flex gap-1 flex-row-reverse">
                          <% for(let i = 5; i >= 1; i--) { %>
                          <input type="radio" id="star_<%= feedback.feedback_id %>_<%= i %>" name="rating" value="<%= i %>" class="hidden" <%= feedback.rating == i ? 'checked' : '' %>>
                          <label for="star_<%= feedback.feedback_id %>_<%= i %>" class="text-2xl cursor-pointer text-gray-300 hover:text-yellow-400">★</label>
                          <% } %>
                        </div>
                      </div>
                    </div>
                    <style>
                      .rating input[type="radio"]:checked~label {
                        color: #facc15;
                        /* Yellow */
                      }
                    </style>
                    <div>
                      <label for="feedback_text_<%= feedback.feedback_id %>" class="block text-xs font-medium text-gray-700">Feedback:</label>
                      <textarea id="feedback_text_<%= feedback.feedback_id %>" name="feedback_text" required class="w-full border p-2 rounded mt-1 min-h-24"><%= feedback.feedback_text %></textarea>
                    </div>

                    <button type="submit" name="action" value="edit" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Update Feedback</button>
                  </form>
                </div>
                <% }) %>
                <% } else { %>
                <div class="col-span-2 py-8 text-center">
                  <div class="text-gray-400 mb-2"><i class="fa-solid fa-comment-dots text-3xl"></i></div>
                  <p class="text-gray-500">You haven't shared any feedback yet.</p>
                  <button onclick="toggleAddFeedbackForm()" class="mt-3 text-blue-600 hover:text-blue-800 font-medium">+ Share your first experience</button>
                </div>
                <% } %>
              </div>
            </div>

            <!-- purchase-tab -->
            <div id="purchase-content" class="tab-content hidden">
              <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-blue-800">Purchase Medicine Here</h3>
                <button onclick="toggleAddPurchaseForm()" class="flex items-center bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                  <i class="fa-solid fa-shopping-cart mr-2"></i> Your Cart
                </button>
              </div>

              <!-- Show Carts added so far -->
              <div id="add-purchase-form" class="hidden mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <h4 class="text-lg font-medium text-blue-800 mb-4">Cart</h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                  <% if (cartItems.length === 0) { %>
                  <div class="col-span-3 py-8 text-center">
                    <div class="text-gray-400 mb-2"><i class="fa-solid fa-shopping-cart text-3xl"></i></div>
                    <p class="text-gray-500">Your cart is empty.</p>
                    <button onclick="toggleAddPurchaseForm()" class="mt-3 text-blue-600 hover:text-blue-800 font-medium">+ Add medicines to your cart</button>
                  </div>
                  <% } %>
                  <% if (cartItems.length > 0) { %>
                  <div class="col-span-3 text-gray-500 mb-4">Total Items: <%= cartItems.length %></div>
                  <% cartItems.forEach(item => { %>
                  <div class="bg-white shadow-lg rounded-lg overflow-hidden p-4 transform hover:scale-105 transition-transform duration-300">
                    <div class="flex flex-col items-center">
                      <!-- Edit & Delete Buttons -->
                      <div class="flex gap-2 self-end">
                        <button onclick="toggleEditForm('purchase-<%= item.purchase_id %>')" class="text-blue-600 hover:text-blue-800">
                          <i class="fa-solid fa-edit"></i>
                        </button>
                        <form action="/customer/customerDashboard/cart/deleteOrEdit" method="POST" class="inline">
                          <input type="hidden" name="purchase_id" value="<%= item.purchase_id %>">
                          <button type="submit" name="action" value="delete" class="text-red-600 hover:text-red-800" onclick="return confirm('Are you sure you want to delete this purchase?')">
                            <i class="fa-solid fa-trash-alt"></i>
                          </button>
                        </form>
                      </div>

                      <!-- Medicine Image -->
                      <% if (item.medicine_img) { %>
                      <img src="data:image/jpeg;base64,<%= item.medicine_img.toString('base64') %>" alt="<%= item.medicine_name %>" class="w-32 h-32 object-cover rounded-md mb-3">
                      <% } else { %>
                      <img src="/img/noImg.jpg" alt="No Image Available" class="w-32 h-32 object-cover rounded-md mb-3">
                      <% } %>

                      <!-- Medicine Details -->
                      <h3 class="text-lg font-semibold text-gray-800"><%= item.medicine_name %></h3>
                      <p class="text-sm text-gray-500"><%= item.medicine_composition %></p>

                      <div class="mt-3 flex flex-col items-center">
                        <p class="text-lg font-bold text-green-600">₹<%= item.medicine_price %></p>
                        <p class="text-gray-700">Quantity: <%= item.purchased_quantity %></p>
                        <p class="text-gray-900 font-semibold mt-2">Total: ₹<%= item.total_amt %></p>
                      </div>

                      <!-- Hidden Edit Form -->
                      <form id="purchase-<%= item.purchase_id %>" action="/customer/customerDashboard/cart/deleteOrEdit" method="POST" class="hidden w-full mt-4">
                        <input type="hidden" name="purchase_id" value="<%= item.purchase_id %>">

                        <!-- Quantity Input -->
                        <div class="flex items-center">
                          <label for="quantity-<%= item.purchase_id %>" class="text-gray-700 mr-2">Qty:</label>
                          <input type="number" name="purchased_quantity" value="<%= item.purchased_quantity %>" id="quantity-<%= item.purchase_id %>" class="w-16 border px-2 py-1 rounded-md" min="1">
                        </div>

                        <!-- Medicine Selection -->
                        <label class="block text-sm font-medium text-gray-700 mt-2" for="medicine_id">Medicine</label>
                        <select name="medicine_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                          <% medicines.forEach(medicine => { %>
                          <option value="<%= medicine.medicine_id %>" <%= medicine.medicine_id === item.medicine_id ? 'selected' : '' %>>
                            <%= medicine.medicine_id %>: <%= medicine.medicine_name %>
                          </option>
                          <% }) %>
                        </select>

                        <!-- Save Changes Button -->
                        <button type="submit" name="action" value="edit" class="text-blue-600 hover:text-blue-800 mt-2">
                          <i class="fa-solid fa-save"></i>
                        </button>
                      </form>
                    </div>
                  </div>
                  <% }) %>
                 
                  <form action="/customer/customerDashboard/cart/pay" method="POST" class="col-span-3 mt-4">
                    <% cartItems.forEach(item => { %>
                    <input type="hidden" name="purchase_id" value="<%= item.purchase_id %>">
                    <% }) %>
                    <!-- Proceed to Payment Button -->
                    <button type="submit" name="action" value="proceedToPay" class="bg-blue-600 text-white px-4 py-2 rounded-md mt-4 hover:bg-blue-800">
                      Proceed to Payment
                    </button>
                  </form>
                </div>
                <% } %>
              </div>
            </div>
            


              <% if (medicines.length > 0) { %>
              <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-3 gap-6">
                <% medicines.forEach(medicine => { %>
                <form action="/customer/customerDashboard/cart/addToCart" method="POST">
                  <input type="hidden" name="medicine_id" value="<%= medicine.medicine_id %>">
                  <div class="border rounded-lg shadow-md p-4 bg-white hover:shadow-lg transition cursor-pointer">
                    <% if (medicine.medicine_img) { %>
                    <img src="data:image/jpeg;base64,<%= medicine.medicine_img.toString('base64') %>" alt="<%= medicine.medicine_name %>" class="w-full h-40 object-cover rounded-md mb-3">
                    <% } else { %>
                    <img src="/img/noImg.jpg" alt="No Image Available" class="w-full h-40 object-cover rounded-md mb-3">
                    <% } %>

                    <h2 class="text-lg font-semibold text-gray-800"><%= medicine.medicine_name %></h2>
                    <p class="text-gray-600 text-sm"><%= medicine.medicine_composition %></p>
                    <p class="text-blue-600 font-bold text-lg mt-2">₹<%= medicine.medicine_price %></p>
                    <p class="text-gray-700 text-sm">Type: <%= medicine.medicine_type %></p>
                    <p class="text-red-500 text-sm">Expiry: <%= new Date(medicine.medicine_expiry_date).toDateString() %></p>

                    <!-- Quantity Input -->
                    <div class="mt-3 flex items-center">
                      <label for="quantity-<%= medicine.medicine_id %>" class="text-gray-700 mr-2">Qty:</label>
                      <input type="number" name="purchased_quantity" id="purchased_quantity-<%= medicine.medicine_id %>" class="w-16 border px-2 py-1 rounded-md" min="1" value="1">
                    </div>


                    <button type="submit" class="mt-3 w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition">
                      Add to Purchase
                    </button>
                </form>
              </div>
              <% }) %>
            </div>
            <% } else { %>
            <div class="col-span-2 py-8 text-center">
              <div class="text-gray-400 mb-2"><i class="fa-solid fa-shopping-cart text-3xl"></i></div>
              <p class="text-gray-500">No medicines found..</p>
              <button onclick="toggleAddPurchaseForm()" class="mt-3 text-blue-600 hover:text-blue-800 font-medium">+ Share your first experience</button>
            </div>
            <% } %>
          </div>
        </div>

        <!-- Purchase History Tab -->
        <div id="invoices-content" class="tab-content hidden">
          <h3 class="text-xl font-semibold text-blue-800 mb-6">Your Purchase History</h3>

          <% if (invoice && invoice.length > 0) { %>
          <div class="space-y-4">
            <% invoice.forEach(row => { %>
            <div class="border rounded-lg shadow-sm hover:shadow-md transition overflow-hidden bg-white">
              <!-- Invoice Header -->
              <div class="bg-gradient-to-r from-blue-50 to-blue-50 p-4 border-b flex flex-wrap justify-between items-center">
                <div>
                  <h4 class="font-semibold text-blue-800">Invoice #<%= row.invoice_no %></h4>
                  <p class="text-sm text-gray-600"><%= new Date(row.invoice_time).toLocaleDateString() %></p>
                </div>
                <div class="text-right">
                  <p class="text-sm text-gray-600">Assisted by: <span class="font-medium"><%= row.admin_username || 'N/A' %></span></p>
                  <button class="mt-2 bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 text-sm" onclick="downloadInvoice('<%= row.invoice_no %>')">
                    <i class="fa-solid fa-download mr-1"></i> Download
                  </button>
                </div>
              </div>

              <!-- Invoice Details -->
              <div class="p-4">
                <!-- Medicines Table -->
                <div class="overflow-x-auto mb-4">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                      <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Medicine</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Composition</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supplier</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expiry</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Qty</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                      </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                      <% 
                            const medicines = row.medicine_names.split(', ');
                            const compositions = row.medicine_compositions.split(', ');
                            const suppliers = row.supplier_names.split(', ');
                            const expiryDates = row.medicine_expiry_dates.split(', ');
                            const prices = row.medicine_prices.split(', ');
                            const quantities = row.purchased_quantities.split(', ');
                            const totals = row.total_amt.split(', ');
                            
                            for(let i = 0; i < medicines.length; i++) { 
                          %>
                      <tr>
                        <td class="px-3 py-2 text-sm text-gray-800"><%= medicines[i] %></td>
                        <td class="px-3 py-2 text-sm text-gray-600"><%= compositions[i] %></td>
                        <td class="px-3 py-2 text-sm text-gray-600"><%= suppliers[i] %></td>
                        <td class="px-3 py-2 text-sm text-gray-600"><%= expiryDates[i] %></td>
                        <td class="px-3 py-2 text-sm text-gray-800 text-right">₹<%= prices[i] %></td>
                        <td class="px-3 py-2 text-sm text-gray-800 text-center"><%= quantities[i] %></td>
                        <td class="px-3 py-2 text-sm text-gray-800 text-right">₹<%= totals[i] %></td>
                      </tr>
                      <% } %>

                      <!-- Summary Row -->
                      <tr class="bg-gray-100 ">
                        <td colspan="4" class="px-3 py-2 text-xs font-medium text-gray-500 text-right">Actual Amount to Pay:</td>
                        <td colspan="3" class="px-3 py-2 text-xs font-medium text-gray-500 text-right">₹<%= row.actual_amt_to_pay %></td>
                      </tr>
                      <tr class="bg-gray-100">
                        <td colspan="4" class="px-3 py-2 text-xs font-medium text-gray-500 text-right">Previous Balance:</td>
                        <td colspan="3" class="px-3 py-2 text-xs font-medium text-gray-500 text-right">₹<%= row.prev_balance %></td>
                      </tr>
                      <tr class="bg-gray-100">
                        <td colspan="4" class="px-3 py-2 text-xs font-medium text-gray-500 text-right">Discount:</td>
                        <td colspan="3" class="px-3 py-2 text-xs font-medium text-gray-500 text-right">₹<%= row.discount %></td>
                      </tr>
                      <tr class="bg-gray-100">
                        <td colspan="4" class="px-3 py-2 text-xs font-medium text-gray-500 text-right">Net Total:</td>
                        <td colspan="3" class="px-3 py-2 text-xs font-medium text-gray-500 text-right">₹<%= row.net_total %></td>
                      </tr>
                      <tr class="bg-gray-100">
                        <td colspan="4" class="px-3 py-2 text-xs font-medium text-right text-green-600">Amount Paid:</td>
                        <td colspan="3" class="px-3 py-2 text-xs font-medium text-right text-green-600">₹<%= row.amount_paid %></td>
                      </tr>
                      <tr class="bg-gray-100">
                        <td colspan="4" class="px-3 py-2 text-xs font-medium text-gray-500 text-right">Payment Date:</td>
                        <td colspan="3" class="px-3 py-2 text-xs font-medium text-gray-500 text-right"><%= row.payment_date ? new Date(row.payment_date).toLocaleString() : 'N/A' %></td>
                      </tr>
                      <tr class="bg-gray-100">
                        <td colspan="4" class="px-3 py-2 text-xs font-medium text-right text-red-600">Current Balance:</td>
                        <td colspan="3" class="px-3 py-2 text-xs font-medium text-right text-red-600">₹<%= row.curr_balance %></td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <% }); %>
          </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>
</div>
</div>
<script>
  // Toggle password visibility
  function togglePassword() {
    const passwordField = document.getElementById('customer_password');
    const passwordToggle = document.getElementById('password-toggle');

    if (passwordField.type === 'password') {
      passwordField.type = 'text';
      passwordToggle.classList.remove('fa-eye');
      passwordToggle.classList.add('fa-eye-slash');
    } else {
      passwordField.type = 'password';
      passwordToggle.classList.remove('fa-eye-slash');
      passwordToggle.classList.add('fa-eye');
    }
  }

  // Preview image before upload
  function previewImage(event) {
    const preview = document.getElementById('image-preview');
    const removeBtn = document.getElementById('remove-image');
    const file = event.target.files[0];

    if (file) {
      preview.src = URL.createObjectURL(file);
      preview.classList.remove('hidden');
      removeBtn.classList.remove('hidden');
    }
  }

  // Remove image preview
  function removeImage() {
    const preview = document.getElementById('image-preview');
    const removeBtn = document.getElementById('remove-image');
    const fileInput = document.getElementById('customer_photo');

    preview.src = '';
    preview.classList.add('hidden');
    removeBtn.classList.add('hidden');
    fileInput.value = '';
  }

  document.querySelector('form').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const loadingSpinner = document.getElementById('loadingSpinner');

    // Show loading state
    submitBtn.disabled = true;
    submitText.textContent = 'Changing Profile...';
    loadingSpinner.classList.remove('hidden');
  });

  // Tab navigation
  function openTab(tabName) {
    // Hide all tab contents
    const tabContents = document.querySelectorAll('.tab-content');
    tabContents.forEach(content => content.classList.add('hidden'));

    // Remove active class from all tab buttons
    const tabButtons = document.querySelectorAll('.tab-btn');
    tabButtons.forEach(btn => {
      btn.classList.remove('bg-blue-50', 'text-blue-800', 'border-b-2', 'border-blue-600');
      btn.classList.add('text-gray-600');
    });

    // Show the selected tab content
    document.getElementById(tabName + '-content').classList.remove('hidden');

    // Add active class to the selected tab button
    const activeTab = document.getElementById(tabName + '-tab');
    activeTab.classList.add('bg-blue-50', 'text-blue-800', 'border-b-2', 'border-blue-600');
    activeTab.classList.remove('text-gray-600');
  }

  // Toggle add address form
  function toggleAddAddressForm() {
    const form = document.getElementById('add-address-form');
    form.classList.toggle('hidden');
  }

  // Toggle edit forms
  function toggleEditForm(id) {
    const form = document.getElementById(id);
    form.classList.toggle('hidden');
  }

  // Toggle add feedback form
  function toggleAddFeedbackForm() {
    const form = document.getElementById('add-feedback-form');
    form.classList.toggle('hidden');
  }

  // Toggle add feedback form
  function toggleAddPurchaseForm() {
    const form = document.getElementById('add-purchase-form');
    form.classList.toggle('hidden');
  }

  // Download invoice (this would likely connect to a backend endpoint)
  function downloadInvoice(invoiceNo) {
    window.location.href = `/customer/download-invoice/${invoiceNo}`;
  }

  // Initialize the first tab on page load
  document.addEventListener('DOMContentLoaded', function() {
    // Set the first tab as active by default
    openTab('purchase');
  });
</script>
<%- include('includes/footer') %>