<%- include('includes/header') %>

<div class="bg-gradient-to-br from-blue-50 to-white flex flex-col items-center min-h-screen p-4">
  <!-- Customer Profile -->
  <div class="mt-4 bg-white p-6 shadow-md rounded-lg w-full max-w-2xl">
    <h2 class="text-xl font-semibold border-b pb-2 mb-4">Your Profile</h2>

    <!-- Customer Photo -->
    <div class="flex justify-center my-4">
      <img src="<%= customer.customer_photo %>" alt="Profile Photo" class="w-24 h-24 rounded-full shadow-md">
    </div>

    <!-- Customer Details -->
    <div class="space-y-2">
      <p><strong>ID:</strong> <%= customer.customer_id %></p>
      <p><strong>Registered On:</strong> <%= new Date(customer.customer_created_at).toLocaleString() %></p>
      <p><strong>Name:</strong> <%= customer.customer_name %></p>
      <p><strong>Email:</strong> <%= customer.customer_email %></p>
      <p><strong>Phone:</strong> <%= customer.customer_ph_no %></p>
      <p><strong>Balance Amount:</strong> $<%= customer.customer_balance_amt %></p>
    </div>

    <!-- Customer Address -->
    <div class="mt-6 bg-gray-50 p-4 rounded-md">
      <h3 class="text-lg font-semibold border-b pb-2 mb-2">Saved Addresses</h3>
      <% if (addresses.length > 0) { %>
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        <% addresses.forEach(address=> { %>
        <div class="border rounded-lg shadow-md p-4 bg-white hover:shadow-lg transition">

          <h2 class="text-lg font-semibold text-gray-800">
            <%= address.address_id %>
          </h2>
          <p class="text-gray-600 text-sm">
            <%= address.address_type %>
          </p>
          <p class="text-gray-600 text-sm">
            <%= address.street %>
          </p>
          <p class="text-gray-600 text-sm">
            <%= address.city %>
          </p>

          <p class="text-gray-600 text-sm">
            <%= address.state %>
          </p>

          <p class="text-gray-600 text-sm">
            <%= address.zip_code %>
          </p>

          <div class="flex gap-2 mt-3">
            <form action="/customer/customerDashboard/address/deleteOrEdit" method="POST" class="w-full">
              <input type="hidden" name="address_id" value="<%= address.address_id %>">
              <button type="submit" name="action" value="delete" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition" onclick="return confirm('Are you sure you want to delete this medicine?')">Delete</button>
            </form>
          </div>

          <button onclick="toggleEditForm('address-<%= address.address_id %>')" class="mt-2 w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">Edit</button>

          <form id="address-<%= address.address_id %>" action="/customer/customerDashboard/address/deleteOrEdit" method="POST" class="mt-4 space-y-2 hidden">
            <input type="hidden" name="address_id" value="<%= address.address_id %>">

            <div class="mb-2">
              <label for="address_type_<%= address.address_id %>" class="block text-sm font-medium text-gray-700">
                Address Type
              </label>
              <select id="address_type_<%= address.address_id %>" name="address_type" required class="w-full border p-2 rounded mb-3">
                <option value="Home" <%= address.address_type === 'Home' ? 'selected' : '' %>>Home</option>
                <option value="Work" <%= address.address_type === 'Work' ? 'selected' : '' %>>Work</option>
                <option value="Other" <%= address.address_type === 'Other' ? 'selected' : '' %>>Other</option>
              </select>
            </div>

            <div class="mb-2">
              <label for="street_<%= address.address_id %>" class="block text-sm font-medium text-gray-700">Street</label>
              <input type="text" id="street_<%= address.address_id %>" name="street" value="<%= address.street %>" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
            </div>

            <div class="mb-2">
              <label for="city_<%= address.address_id %>" class="block text-sm font-medium text-gray-700">City</label>
              <input type="text" id="city_<%= address.address_id %>" name="city" value="<%= address.city %>" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
            </div>

            <div class="mb-2">
              <label for="state_<%= address.address_id %>" class="block text-sm font-medium text-gray-700">State</label>
              <input type="text" id="state_<%= address.address_id %>" name="state" value="<%= address.state %>" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
            </div>

            <div class="mb-2">
              <label for="zip_code_<%= address.address_id %>" class="block text-sm font-medium text-gray-700">Zip Code</label>
              <input type="text" id="zip_code_<%= address.address_id %>" name="zip_code" value="<%= address.zip_code %>" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
            </div>

            <button type="submit" name="action" value="edit" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Save
              Changes</button>
          </form>
        </div>
        <% }) %>
      </div>
      
      <% } else { %>
      <p class="text-gray-500">No address saved.</p>
      <% } %>
    </div>

    <!-- Customer Feedback -->
    <div class="mt-6 bg-gray-50 p-4 rounded-md">
      <h3 class="text-lg font-semibold border-b pb-2 mb-2">Your Feedback</h3>
      <% if (feedbacks.length > 0) { %>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
          <% feedbacks.forEach(feedback=> { %>
          <div class="border rounded-lg shadow-md p-4 bg-white hover:shadow-lg transition">
  
            <h2 class="text-lg font-semibold text-gray-800">
              <%= feedback.feedback_id %>
            </h2>
            <p class="text-gray-600 text-sm">
              <%= feedback.feedback_date %>
            </p>
            <p class="text-gray-600 text-sm">
              <%= feedback.rating %>
            </p>
            <p class="text-gray-600 text-sm">
              <%= feedback.feedback_text %>
            </p>
            
  
            <div class="flex gap-2 mt-3">
              <form action="/customer/customerDashboard/feedback/deleteOrEdit" method="POST" class="w-full">
                <input type="hidden" name="feedback_id" value="<%= feedback.feedback_id %>">
                <button type="submit" name="action" value="delete" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition" onclick="return confirm('Are you sure you want to delete this medicine?')">Delete</button>
              </form>
            </div>
  
            <button onclick="toggleEditForm('feedback-<%= feedback.feedback_id %>')" class="mt-2 w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">Edit</button>
  
            <form id="feedback-<%= feedback.feedback_id %>" action="/customer/customerDashboard/feedback/deleteOrEdit" method="POST" class="mt-4 space-y-2 hidden">
              <input type="hidden" name="feedback_id" value="<%= feedback.feedback_id %>">

              <div class="mb-2">
                <label for="rating_<%= feedback.feedback_id %>" class="block text-sm font-medium text-gray-700">Rating</label>
                <input type="number" min="1" max="5" id="rating_<%= feedback.feedback_id %>" name="rating" value="<%= feedback.rating %>" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
              </div>
  
              <div class="mb-2">
                <label for="feedback_text_<%= feedback.feedback_id %>" class="block text-sm font-medium text-gray-700">Feedback Text</label>
                <input type="text" id="feedback_text_<%= feedback.feedback_id %>" name="feedback_text" value="<%= feedback.feedback_text %>" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
              </div>
  
              <button type="submit" name="action" value="edit" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Save
                Changes</button>
            </form>
          </div>
          <% }) %>
        </div>  
      <% } else { %>
      <p class="text-gray-500">No feedback available.</p>
      <% } %>
    </div>
  </div>

  <!-- Update Profile Form -->
  <form action="/customer/update/customerDashboard" method="POST" enctype="multipart/form-data" class="mt-4 w-full max-w-2xl bg-white p-6 shadow-md rounded-lg">
    <input type="hidden" name="customer_id" value="<%= customer.customer_id %>">

    <h2 class="text-xl font-semibold mb-4">Update Profile</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Full Name Field -->
      <div>
        <label for="customer_name" class="block text-sm font-medium text-gray-700 mb-1">
          Name
        </label>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fa-solid fa-user text-gray-400"></i>
          </div>
          <input type="text" id="customer_name" name="customer_name" value="<%= customer.customer_name %>" required class="block w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg 
                             text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 
                             focus:ring-indigo-500 focus:border-transparent transition-all duration-200" placeholder="Enter your full name">
        </div>
      </div>

      <!-- Email Field -->
      <div>
        <label for="customer_email" class="block text-sm font-medium text-gray-700 mb-1">
          Email Address
        </label>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fa-solid fa-envelope text-gray-400"></i>
          </div>
          <input type="email" id="customer_email" name="customer_email" value="<%= customer.customer_email %>" required class="block w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg 
                             text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 
                             focus:ring-indigo-500 focus:border-transparent transition-all duration-200" placeholder="Enter your email address">
        </div>
      </div>

      <!-- Phone Number Field -->
      <div>
        <label for="customer_ph_no" class="block text-sm font-medium text-gray-700 mb-1">
          Phone Number
        </label>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fa-solid fa-phone text-gray-400"></i>
          </div>
          <input type="tel" id="customer_ph_no" name="customer_ph_no" value="<%= customer.customer_ph_no %>" required class="block w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg 
                             text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 
                             focus:ring-indigo-500 focus:border-transparent transition-all duration-200" placeholder="Enter your phone number">
        </div>
      </div>

      <div>
        <label for="customer_photo" class="block text-sm font-medium text-gray-700 mb-1">Upload Photo <span class="text-red-500">Only image files are allowed!</span></label>
        <input type="file" id="customer_photo" name="customer_photo" accept="image/*" class="block w-full py-3 border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200" onchange="previewImage(event)">

        <div class="mt-3 flex items-center gap-4">
          <img id="image-preview" class="w-24 h-24 rounded-full border border-gray-300 object-cover hidden shadow-md" alt="Profile Preview">
          <button type="button" id="remove-image" class="hidden text-sm text-red-500 hover:text-red-700 font-medium" onclick="removeImage()">Remove</button>
        </div>
      </div>

      <div>
        <label for="customer_password" class="block text-sm font-medium text-gray-700 mb-1">Password <span class="text-red-500">*</span></label>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fas fa-lock text-gray-400"></i>
          </div>
          <input type="password" id="customer_password" name="customer_password" required class="block w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" placeholder="Enter your password">
          <button type="button" onclick="togglePassword()" class="absolute inset-y-0 right-0 pr-3 flex items-center">
            <i id="password-toggle" class="fas fa-eye text-gray-400 hover:text-gray-600 cursor-pointer"></i>
          </button>
        </div>
      </div>
    </div>

    <div class="mt-4">
      <button type="submit" id="submitBtn" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200">
        <div class="flex items-center">
          <i class="fas fa-sign-in-alt mr-2"></i>
          <span id="submitText">Save Changes</span>
        </div>
        <span id="loadingSpinner" class="hidden ml-2">
          <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </span>
      </button>
    </div>
  </form>



  <div class="max-w-3xl mx-auto bg-white p-6 rounded-lg shadow-lg">

    <h1 class="text-2xl font-bold text-center mb-6">Customer Dashboard</h1>

    <!-- Add Address Form -->
    <h2 class="text-xl font-semibold mb-3">Add Address</h2>
    <form action="/customer/customerDashboard/address/add" method="POST" class="bg-gray-50 p-4 rounded-md shadow-md">
      <label class="block">Street:</label>
      <input type="text" name="street" required class="w-full border p-2 rounded mb-2">

      <label class="block">City:</label>
      <input type="text" name="city" required class="w-full border p-2 rounded mb-2">

      <label class="block">State:</label>
      <input type="text" name="state" required class="w-full border p-2 rounded mb-2">

      <label class="block">ZIP Code:</label>
      <input type="text" name="zip_code" required class="w-full border p-2 rounded mb-2">

      <label class="block">Address Type:</label>
      <select name="address_type" class="w-full border p-2 rounded mb-3">
        <option value="Home">Home</option>
        <option value="Work">Work</option>
        <option value="Other">Other</option>
      </select>

      <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">Add Address</button>
    </form>

    <hr class="my-6">

    <!-- Submit Feedback Form -->
    <h2 class="text-xl font-semibold mb-3">Submit Feedback</h2>
    <form action="/customer/customerDashboard/feedback/add" method="POST" class="bg-gray-50 p-4 rounded-md shadow-md">
      <label class="block">Rating (1-5):</label>
      <input type="number" name="rating" min="1" max="5" required class="w-full border p-2 rounded mb-2">

      <label class="block">Feedback:</label>
      <textarea name="feedback_text" required class="w-full border p-2 rounded mb-3"></textarea>

      <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">Submit Feedback</button>
    </form>


  </div>



  <div class="max-w-6xl mx-auto bg-white shadow-lg rounded-lg p-6">
    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Customer Invoice</h2>

    <% if (invoice.length > 0) { %>
    <div class="overflow-x-auto">
      <table class="min-w-full bg-white border border-gray-300">
        <thead>
          <tr class="bg-blue-600 text-white">
            <th class="px-4 py-2">Invoice No</th>
            <th class="px-4 py-2">Date</th>
            <th class="px-4 py-2">Admin</th>
            <th class="px-4 py-2">Medicines</th>
            <th class="px-4 py-2">Composition</th>
            <th class="px-4 py-2">Suppliers</th>
            <th class="px-4 py-2">Expiry Dates</th>
            <th class="px-4 py-2">Prices</th>
            <th class="px-4 py-2">Qty</th>
            <th class="px-4 py-2">Total</th>
            <th class="px-4 py-2">Payable</th>
            <th class="px-4 py-2">Prev Balance</th>
            <th class="px-4 py-2">Discount</th>
            <th class="px-4 py-2">Net Total</th>
            <th class="px-4 py-2">Paid</th>
            <th class="px-4 py-2">Payment Date</th>
            <th class="px-4 py-2">Balance</th>
            <th class="px-4 py-2">Bill</th>
          </tr>
        </thead>
        <tbody>
          <% invoice.forEach(row => { %>
          <tr class="border-b hover:bg-gray-100">
            <td class="px-4 py-2"><%= row.invoice_no %></td>
            <td class="px-4 py-2"><%= new Date(row.invoice_time).toLocaleString() %></td>
            <td class="px-4 py-2"><%= row.admin_username || 'N/A' %></td>
            <td class="px-4 py-2"><%- row.medicine_names.split(', ').join('<br>') %></td>
            <td class="px-4 py-2"><%- row.medicine_compositions.split(', ').join('<br>') %></td>
            <td class="px-4 py-2"><%- row.supplier_names.split(', ').join('<br>') %></td>
            <td class="px-4 py-2"><%- row.medicine_expiry_dates.split(', ').join('<br>') %></td>
            <td class="px-4 py-2 text-right"><%- row.medicine_prices.split(', ').join('<br>') %></td>
            <td class="px-4 py-2 text-center"><%- row.purchased_quantities.split(', ').join('<br>') %></td>
            <td class="px-4 py-2 text-right">₹<%- row.total_amt.split(', ').join('<br>') %></td>
            <td class="px-4 py-2 text-right">₹<%= row.actual_amt_to_pay %></td>
            <td class="px-4 py-2 text-right">₹<%= row.prev_balance %></td>
            <td class="px-4 py-2 text-right">₹<%= row.discount %></td>
            <td class="px-4 py-2 text-right">₹<%= row.net_total %></td>
            <td class="px-4 py-2 text-right text-green-600 font-semibold">₹<%= row.amount_paid %></td>
            <td class="px-4 py-2"><%= row.payment_date ? new Date(row.payment_date).toLocaleString() : 'N/A' %></td>
            <td class="px-4 py-2 text-right text-red-600 font-semibold">₹<%= row.curr_balance %></td>
            <td><button class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-700" onclick="downloadInvoice('<%= row.invoice_no %>')">
                Download
              </button></td>
            <script>
              function downloadInvoice(invoiceNo) {
                window.location.href = `/customer/download-invoice/${invoiceNo}`;
              }
            </script>
          </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <% } else { %>
    <p class="text-gray-600">No invoices found for this customer.</p>
    <% } %>
  </div>
</div>


<script>

        function toggleEditForm(formId) {
          const form = document.getElementById(formId);
          if (form.classList.contains('hidden')) {
            form.classList.remove('hidden');
          } else {
            form.classList.add('hidden');
          }
        }

  function togglePassword() {
    const passwordInput = document.getElementById('customer_password');
    const passwordToggle = document.getElementById('password-toggle');

    if (passwordInput.type === 'password') {
      passwordInput.type = 'text';
      passwordToggle.classList.replace('fa-eye', 'fa-eye-slash');
    } else {
      passwordInput.type = 'password';
      passwordToggle.classList.replace('fa-eye-slash', 'fa-eye');
    }
  }

  function previewImage(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const imgElement = document.getElementById("image-preview");
        const removeButton = document.getElementById("remove-image");
        imgElement.src = e.target.result;
        imgElement.classList.remove("hidden");
        removeButton.classList.remove("hidden");
      };
      reader.readAsDataURL(file);
    }
  }

  function removeImage() {
    document.getElementById("image-preview").classList.add("hidden");
    document.getElementById("remove-image").classList.add("hidden");
    document.getElementById("customer_photo").value = "";
  }

  document.querySelector('form').addEventListener('submit', function() {
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('submitText').textContent = 'Changing Profile...';
    document.getElementById('loadingSpinner').classList.remove('hidden');
  });


</script>
<%- include('includes/footer') %>